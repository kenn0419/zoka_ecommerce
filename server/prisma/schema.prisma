// ===========================================
// ShopVerse Marketplace Data Model
// ===========================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  hashedPassword String
  fullName       String
  slug           String   @unique
  phone          String   @unique
  avatarUrl      String?
  address        String
  status         String   @default("PENDING")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sessions              UserSession[]
  roles                 UserRole[]
  shops                 Shop[]
  orders                Order[]         @relation("UserOrders")
  reviews               ProductReview[]
  conversationsAsBuyer  Conversation[]  @relation("BuyerConversations")
  conversationsAsSeller Conversation[]  @relation("SellerConversations")
  messages              Message[]
  carts                 Cart[]
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  device       String?
  ipAddress    String?
  refreshToken String
  publicKey    String
  privateKey   String
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

// Roles & Permissions
model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles RolePermission[]
}

model UserRole {
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

// ===================== SHOP =====================

model Shop {
  id          String   @id @default(uuid())
  ownerId     String
  name        String
  slug        String   @unique
  description String?
  logoUrl     String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner      User           @relation(fields: [ownerId], references: [id])
  products   Product[]
  categories ShopCategory[]
  flashSales FlashSale[]
  orders     Order[]
}

model ShopCategory {
  id          String   @id @default(uuid())
  shopId      String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shop Shop @relation(fields: [shopId], references: [id])
}

// ===================== PRODUCT =====================

model Category {
  id           String   @id @default(uuid())
  name         String
  slug         String   @unique
  parentId     String?
  description  String?
  thumbnailUrl String
  status       String   @default("PENDING")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  parent   Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children Category[] @relation("CategoryParent")
  products Product[]
}

model Product {
  id          String   @id @default(uuid())
  shopId      String
  categoryId  String
  name        String
  slug        String   @unique
  description String?
  status      String   @default("PENDING")
  thumbnail   String
  minPrice    Decimal?
  maxPrice    Decimal?
  avgRating   Float?   @default(0)
  hasStock    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shop           Shop             @relation(fields: [shopId], references: [id])
  category       Category         @relation(fields: [categoryId], references: [id])
  variants       ProductVariant[]
  orderItems     OrderItem[]
  flashSaleItems FlashSaleItem[]
  reviews        ProductReview[]
  cartItems      CartItem[]
}

model ProductVariant {
  id        String         @id @default(uuid())
  productId String
  name      String
  price     Decimal
  stock     Int
  images    VariantImage[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  product   Product    @relation(fields: [productId], references: [id])
  cartItems CartItem[]
}

model VariantImage {
  id        String   @id @default(uuid())
  variantId String
  imageUrl  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

// ===================== CART ======================

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id])
  items CartItem[]
}

model CartItem {
  id            String   @id @default(uuid())
  cartId        String
  productId     String
  variantId     String
  productName   String
  variantName   String
  imageUrl      String
  priceSnapshot Decimal
  stockSnapshot Int
  quantity      Int      @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  cart    Cart            @relation(fields: [cartId], references: [id])
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])
}

// ===================== FLASH SALE =====================

model FlashSale {
  id        String   @id @default(uuid())
  shopId    String
  name      String
  startTime DateTime
  endTime   DateTime
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shop  Shop            @relation(fields: [shopId], references: [id])
  items FlashSaleItem[]
}

model FlashSaleItem {
  flashSaleId String
  productId   String
  salePrice   Decimal
  quantity    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  flashSale FlashSale @relation(fields: [flashSaleId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])

  @@id([flashSaleId, productId])
}

// ===================== COUPON ====================

model Coupon {
  id          String    @id @default(uuid())
  code        String    @unique
  description String?
  discount    Decimal // số tiền giảm hoặc % giảm tùy type
  type        String // "FIXED" | "PERCENTAGE"
  usageLimit  Int? // số lần sử dụng tối đa
  usedCount   Int       @default(0)
  minOrder    Decimal? // giá trị tối thiểu để áp dụng
  startAt     DateTime?
  endAt       DateTime?
  status      String    @default("ACTIVE") // ACTIVE | EXPIRED | INACTIVE
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  orders Order[] // liên kết với các order đã dùng coupon
}

// ===================== ORDER =====================

model Order {
  id         String   @id @default(uuid())
  buyerId    String
  shopId     String
  totalPrice Decimal
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  buyer    User        @relation("UserOrders", fields: [buyerId], references: [id])
  shop     Shop        @relation(fields: [shopId], references: [id])
  items    OrderItem[]
  coupon   Coupon?     @relation(fields: [couponId], references: [id])
  couponId String?
}

model OrderItem {
  orderId   String
  productId String
  quantity  Int
  price     Decimal
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@id([orderId, productId])
}

// ===================== REVIEW =====================

model ProductReview {
  id        String   @id @default(uuid())
  productId String
  buyerId   String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])
  buyer   User    @relation(fields: [buyerId], references: [id])
}

// ===================== CHAT =====================

model Conversation {
  id        String   @id @default(uuid())
  buyerId   String
  sellerId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  buyer    User      @relation("BuyerConversations", fields: [buyerId], references: [id])
  seller   User      @relation("SellerConversations", fields: [sellerId], references: [id])
  messages Message[]
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id])
  sender       User         @relation(fields: [senderId], references: [id])
}
